/*
Purpose: 1. Created a modulated signal from the DAQ to drive the laser
2. Do the DSP on the signal coming from the PMT
LIF Senior Project
*/
#include "/home/samuelwg/Arduino/libraries/ADC/ADC-master/ADC.h"

#define BAUD_RATE 115200
#define TIMER_INT_MICROS 200
#define LENGTH_OF_DAC 10
#define LENGTH_OF_SIGNAL 37

#define N_FILTER_LENGTH 37

float in_array[LENGTH_OF_SIGNAL]; 
float volatile after_BPF[LENGTH_OF_SIGNAL]; 
float volatile after_cos_mult[LENGTH_OF_SIGNAL];
int volatile after_LPF;

float pmt_signal[1001] = {
       4.80089224e-61,   7.56428784e-61,   9.52404793e-61,
         8.73799904e-61,   4.19300267e-61,   0.00000000e+00,
         1.25964762e-60,   7.88605593e-60,   2.58222073e-59,
         6.16117815e-59,   1.17473960e-58,   1.83046826e-58,
         2.27924093e-58,   2.06802203e-58,   9.81392677e-59,
         0.00000000e+00,   2.88347211e-58,   1.78525823e-57,
         5.78108107e-57,   1.36412437e-56,   2.57220937e-56,
         3.96370584e-56,   4.88094545e-56,   4.37969014e-56,
         2.05544350e-56,   0.00000000e+00,   5.90646313e-56,
         3.61649019e-55,   1.15816334e-54,   2.70264640e-54,
         5.03983226e-54,   7.68043270e-54,   9.35325406e-54,
         8.29997279e-54,   3.85223997e-54,   0.00000000e+00,
         1.08264057e-53,   6.55569285e-53,   2.07623078e-52,
         4.79147853e-52,   8.83630922e-52,   1.33172642e-51,
         1.60386040e-51,   1.40752141e-51,   6.46050071e-52,
         0.00000000e+00,   1.77576771e-51,   1.06339585e-50,
         3.33063080e-50,   7.60142336e-50,   1.38634329e-49,
         2.06628110e-49,   2.46102179e-49,   2.13588766e-49,
         9.69536319e-50,   0.00000000e+00,   2.60635201e-49,
         1.54353465e-48,   4.78104048e-48,   1.07910910e-47,
         1.94632663e-47,   2.86885664e-47,   3.37916507e-47,
         2.90032631e-47,   1.30198819e-47,   0.00000000e+00,
         3.42314301e-47,   2.00485451e-46,   6.14134373e-46,
         1.37082130e-45,   2.44515120e-45,   3.56429260e-45,
         4.15191463e-45,   3.52419861e-45,   1.56457023e-45,
         0.00000000e+00,   4.02311154e-45,   2.33020643e-44,
         7.05910184e-44,   1.55826527e-43,   2.74878501e-43,
         3.96262439e-43,   4.56491274e-43,   3.83194217e-43,
         1.68239566e-43,   0.00000000e+00,   4.23101107e-43,
         2.42354446e-42,   7.26073434e-42,   1.58506471e-41,
         2.76516394e-41,   3.94218975e-41,   4.49119180e-41,
         3.72840065e-41,   1.61884875e-41,   0.00000000e+00,
         3.98172541e-41,   2.25555095e-40,   6.68277292e-40,
         1.44277185e-39,   2.48912125e-39,   3.50943497e-39,
         3.95399197e-39,   3.24617000e-39,   1.39389309e-39,
         0.00000000e+00,   3.35307687e-39,   1.87844875e-38,
         5.50399358e-38,   1.17515020e-37,   2.00500878e-37,
         2.79564441e-37,   3.11497826e-37,   2.52909419e-37,
         1.07398376e-37,   0.00000000e+00,   2.52674125e-37,
         1.39988099e-36,   4.05643191e-36,   8.56513392e-36,
         1.44521201e-35,   1.99283674e-35,   2.19593417e-35,
         1.76320904e-35,   7.40476058e-36,   0.00000000e+00,
         1.70381756e-35,   9.33529274e-35,   2.67519547e-34,
         5.58624519e-34,   9.32163093e-34,   1.27117858e-33,
         1.38525163e-33,   1.09998728e-33,   4.56845535e-34,
         0.00000000e+00,   1.02808841e-33,   5.57070067e-33,
         1.57874471e-32,   3.26024987e-32,   5.38018616e-32,
         7.25581953e-32,   7.81957373e-32,   6.14068160e-32,
         2.52216100e-32,   0.00000000e+00,   5.55114917e-32,
         2.97465608e-31,   8.33706817e-31,   1.70265570e-30,
         2.77873902e-30,   3.70605137e-30,   3.94986768e-30,
         3.06754225e-30,   1.24600931e-30,   0.00000000e+00,
         2.68213349e-30,   1.42137528e-29,   3.93967009e-29,
         7.95697229e-29,   1.28423137e-28,   1.69387537e-28,
         1.78536523e-28,   1.37122772e-28,   5.50826497e-29,
         0.00000000e+00,   1.15963933e-28,   6.07751183e-28,
         1.66590954e-27,   3.32746818e-27,   5.31109225e-27,
         6.92781898e-27,   7.22132108e-27,   5.48496263e-27,
         2.17898087e-27,   0.00000000e+00,   4.48652966e-27,
         2.32534783e-26,   6.30359109e-26,   1.24515964e-25,
         1.96548382e-25,   2.53545943e-25,   2.61367327e-25,
         1.96328261e-25,   7.71324400e-26,   0.00000000e+00,
         1.55325660e-25,   7.96150357e-25,   2.13437000e-24,
         4.16947348e-24,   6.50878852e-24,   8.30351278e-24,
         8.46507858e-24,   6.28835460e-24,   2.44323803e-24,
         0.00000000e+00,   4.81194803e-24,   2.43919949e-23,
         6.46690440e-23,   1.24934520e-22,   1.92874985e-22,
         2.43339218e-22,   2.45332876e-22,   1.80233819e-22,
         6.92531523e-23,   0.00000000e+00,   1.33396276e-22,
         6.68720452e-22,   1.75334844e-21,   3.34987614e-21,
         5.11442373e-21,   6.38127434e-21,   6.36246730e-21,
         4.62253921e-21,   1.75654133e-21,   0.00000000e+00,
         3.30911259e-21,   1.64054047e-20,   4.25387847e-20,
         8.03748367e-20,   1.21356367e-19,   1.49743432e-19,
         1.47652374e-19,   1.06088908e-19,   3.98677984e-20,
         0.00000000e+00,   7.34555200e-20,   3.60142477e-19,
         9.23521444e-19,   1.72566510e-18,   2.57675711e-18,
         3.14436681e-18,   3.06619917e-18,   2.17873502e-18,
         8.09713153e-19,   0.00000000e+00,   1.45909103e-18,
         7.07468006e-18,   1.79413016e-17,   3.31541565e-17,
         4.89586526e-17,   5.90831558e-17,   5.69777570e-17,
         4.00390631e-17,   1.47158445e-17,   0.00000000e+00,
         2.59349490e-17,   1.24361033e-16,   3.11893244e-16,
         5.69986421e-16,   8.32396968e-16,   9.93434463e-16,
         9.47448019e-16,   6.58428250e-16,   2.39322894e-16,
         0.00000000e+00,   4.12509034e-16,   1.95617134e-15,
         4.85180174e-15,   8.76871780e-15,   1.26641655e-14,
         1.49471990e-14,   1.40977723e-14,   9.68898008e-15,
         3.48279858e-15,   0.00000000e+00,   5.87119613e-15,
         2.75343305e-14,   6.75375312e-14,   1.20712636e-13,
         1.72412094e-13,   2.01245172e-13,   1.87711401e-13,
         1.27582976e-13,   4.53542019e-14,   0.00000000e+00,
         7.47764375e-14,   3.46806484e-13,   8.41264136e-13,
         1.48701187e-12,   2.10040929e-12,   2.42457812e-12,
         2.23653587e-12,   1.50332351e-12,   5.28508233e-13,
         0.00000000e+00,   8.52212715e-13,   3.90881354e-12,
         9.37701532e-12,   1.63915941e-11,   2.28973485e-11,
         2.61391794e-11,   2.38454840e-11,   1.58510205e-11,
         5.51100801e-12,   0.00000000e+00,   8.69113121e-12,
         3.94228263e-11,   9.35280617e-11,   1.61686219e-10,
         2.23363144e-10,   2.52169626e-10,   2.27500038e-10,
         1.49557111e-10,   5.14227603e-11,   0.00000000e+00,
         7.93139649e-11,   3.55791540e-10,   8.34765131e-10,
         1.42715084e-09,   1.94976779e-09,   2.17690089e-09,
         1.94223539e-09,   1.26270518e-09,   4.29363167e-10,
         0.00000000e+00,   6.47691314e-10,   2.87335003e-09,
         6.66701947e-09,   1.12722810e-08,   1.52299797e-08,
         1.68162672e-08,   1.48377247e-08,   9.53985806e-09,
         3.20803608e-09,   0.00000000e+00,   4.73294592e-09,
         2.07647406e-08,   4.76479482e-08,   7.96707293e-08,
         1.06453714e-07,   1.16242675e-07,   1.01432660e-07,
         6.44951301e-08,   2.14485906e-08,   0.00000000e+00,
         3.09485331e-08,   1.34279447e-07,   3.04720550e-07,
         5.03884312e-07,   6.65836147e-07,   7.19029407e-07,
         6.20487983e-07,   3.90172800e-07,   1.28322654e-07,
         0.00000000e+00,   1.81089660e-07,   7.77029726e-07,
         1.74383078e-06,   2.85172694e-06,   3.72665317e-06,
         3.97990556e-06,   3.39651857e-06,   2.11218578e-06,
         6.86994031e-07,   0.00000000e+00,   9.48183288e-07,
         4.02356277e-06,   8.93001098e-06,   1.44420917e-05,
         1.86644691e-05,   1.97126013e-05,   1.66371783e-05,
         1.02318060e-05,   3.29114981e-06,   0.00000000e+00,
         4.44258756e-06,   1.86435661e-05,   4.09208555e-05,
         6.54481410e-05,   8.36483472e-05,   8.73695635e-05,
         7.29239870e-05,   4.43524421e-05,   1.41087130e-05,
         0.00000000e+00,   1.86262211e-05,   7.73022705e-05,
         1.67796336e-04,   2.65405299e-04,   3.35462628e-04,
         3.46514532e-04,   2.86026451e-04,   1.72039367e-04,
         5.41217962e-05,   0.00000000e+00,   6.98809127e-05,
         2.86814148e-04,   6.15694536e-04,   9.63090109e-04,
         1.20385999e-03,   1.22978105e-03,   1.00389212e-03,
         5.97149662e-04,   1.85781328e-04,   0.00000000e+00,
         2.34605096e-04,   9.52256507e-04,   2.02159048e-03,
         3.12729833e-03,   3.86592014e-03,   3.90552298e-03,
         3.15292002e-03,   1.85474242e-03,   5.70659407e-04,
         0.00000000e+00,   7.04792658e-04,   2.82912662e-03,
         5.93972209e-03,   9.08692115e-03,   1.11089965e-02,
         1.10987906e-02,   8.86102411e-03,   5.15500480e-03,
         1.56854491e-03,   0.00000000e+00,   1.89465595e-03,
         7.52135138e-03,   1.56165151e-02,   2.36270372e-02,
         2.85655008e-02,   2.82239096e-02,   2.22843484e-02,
         1.28209322e-02,   3.85799793e-03,   0.00000000e+00,
         4.55768603e-03,   1.78930522e-02,   3.67406793e-02,
         5.49726695e-02,   6.57285286e-02,   6.42249458e-02,
         5.01488548e-02,   2.85335093e-02,   8.49125888e-03,
         0.00000000e+00,   9.81077932e-03,   3.80906197e-02,
         7.73491055e-02,   1.14453597e-01,   1.35335283e-01,
         1.30778207e-01,   1.00987392e-01,   5.68245272e-02,
         1.67235022e-02,   0.00000000e+00,   1.88976442e-02,
         7.25599048e-02,   1.45716411e-01,   2.13234329e-01,
         2.49352209e-01,   2.38293429e-01,   1.81977776e-01,
         1.01265505e-01,   2.94732099e-02,   0.00000000e+00,
         3.25729345e-02,   1.23685967e-01,   2.45644303e-01,
         3.55492023e-01,   4.11112291e-01,   3.88538281e-01,
         2.93436818e-01,   1.61485038e-01,   4.64807044e-02,
         0.00000000e+00,   5.02401770e-02,   1.88664074e-01,
         3.70552702e-01,   5.30331780e-01,   6.06530660e-01,
         5.66892378e-01,   4.23404934e-01,   2.30434821e-01,
         6.55938350e-02,   0.00000000e+00,   6.93410628e-02,
         2.57515306e-01,   5.00193828e-01,   7.07962906e-01,
         8.00737403e-01,   7.40137621e-01,   5.46691451e-01,
         2.94244923e-01,   8.28320485e-02,   0.00000000e+00,
         8.56396502e-02,   3.14529905e-01,   6.04187493e-01,
         8.45704051e-01,   9.45959469e-01,   8.64707846e-01,
         6.31645938e-01,   3.36213316e-01,   9.36006444e-02,
         0.00000000e+00,   9.46464508e-02,   3.43768357e-01,
         6.53055649e-01,   9.04006132e-01,   1.00000000e+00,
         9.04006132e-01,   6.53055649e-01,   3.43768357e-01,
         9.46464508e-02,   0.00000000e+00,   9.36006444e-02,
         3.36213316e-01,   6.31645938e-01,   8.64707846e-01,
         9.45959469e-01,   8.45704051e-01,   6.04187493e-01,
         3.14529905e-01,   8.56396502e-02,   0.00000000e+00,
         8.28320485e-02,   2.94244923e-01,   5.46691451e-01,
         7.40137621e-01,   8.00737403e-01,   7.07962906e-01,
         5.00193828e-01,   2.57515306e-01,   6.93410628e-02,
         0.00000000e+00,   6.55938350e-02,   2.30434821e-01,
         4.23404934e-01,   5.66892378e-01,   6.06530660e-01,
         5.30331780e-01,   3.70552702e-01,   1.88664074e-01,
         5.02401770e-02,   0.00000000e+00,   4.64807044e-02,
         1.61485038e-01,   2.93436818e-01,   3.88538281e-01,
         4.11112291e-01,   3.55492023e-01,   2.45644303e-01,
         1.23685967e-01,   3.25729345e-02,   0.00000000e+00,
         2.94732099e-02,   1.01265505e-01,   1.81977776e-01,
         2.38293429e-01,   2.49352209e-01,   2.13234329e-01,
         1.45716411e-01,   7.25599048e-02,   1.88976442e-02,
         0.00000000e+00,   1.67235022e-02,   5.68245272e-02,
         1.00987392e-01,   1.30778207e-01,   1.35335283e-01,
         1.14453597e-01,   7.73491055e-02,   3.80906197e-02,
         9.81077932e-03,   0.00000000e+00,   8.49125888e-03,
         2.85335093e-02,   5.01488548e-02,   6.42249458e-02,
         6.57285286e-02,   5.49726695e-02,   3.67406793e-02,
         1.78930522e-02,   4.55768603e-03,   0.00000000e+00,
         3.85799793e-03,   1.28209322e-02,   2.22843484e-02,
         2.82239096e-02,   2.85655008e-02,   2.36270372e-02,
         1.56165151e-02,   7.52135138e-03,   1.89465595e-03,
         0.00000000e+00,   1.56854491e-03,   5.15500480e-03,
         8.86102411e-03,   1.10987906e-02,   1.11089965e-02,
         9.08692115e-03,   5.93972209e-03,   2.82912662e-03,
         7.04792658e-04,   0.00000000e+00,   5.70659407e-04,
         1.85474242e-03,   3.15292002e-03,   3.90552298e-03,
         3.86592014e-03,   3.12729833e-03,   2.02159048e-03,
         9.52256507e-04,   2.34605096e-04,   0.00000000e+00,
         1.85781328e-04,   5.97149662e-04,   1.00389212e-03,
         1.22978105e-03,   1.20385999e-03,   9.63090109e-04,
         6.15694536e-04,   2.86814148e-04,   6.98809127e-05,
         0.00000000e+00,   5.41217962e-05,   1.72039367e-04,
         2.86026451e-04,   3.46514532e-04,   3.35462628e-04,
         2.65405299e-04,   1.67796336e-04,   7.73022705e-05,
         1.86262211e-05,   0.00000000e+00,   1.41087130e-05,
         4.43524421e-05,   7.29239870e-05,   8.73695635e-05,
         8.36483472e-05,   6.54481410e-05,   4.09208555e-05,
         1.86435661e-05,   4.44258756e-06,   0.00000000e+00,
         3.29114981e-06,   1.02318060e-05,   1.66371783e-05,
         1.97126013e-05,   1.86644691e-05,   1.44420917e-05,
         8.93001098e-06,   4.02356277e-06,   9.48183288e-07,
         0.00000000e+00,   6.86994031e-07,   2.11218578e-06,
         3.39651857e-06,   3.97990556e-06,   3.72665317e-06,
         2.85172694e-06,   1.74383078e-06,   7.77029726e-07,
         1.81089660e-07,   0.00000000e+00,   1.28322654e-07,
         3.90172800e-07,   6.20487983e-07,   7.19029407e-07,
         6.65836147e-07,   5.03884312e-07,   3.04720550e-07,
         1.34279447e-07,   3.09485331e-08,   0.00000000e+00,
         2.14485906e-08,   6.44951301e-08,   1.01432660e-07,
         1.16242675e-07,   1.06453714e-07,   7.96707293e-08,
         4.76479482e-08,   2.07647406e-08,   4.73294592e-09,
         0.00000000e+00,   3.20803608e-09,   9.53985806e-09,
         1.48377247e-08,   1.68162672e-08,   1.52299797e-08,
         1.12722810e-08,   6.66701947e-09,   2.87335003e-09,
         6.47691314e-10,   0.00000000e+00,   4.29363167e-10,
         1.26270518e-09,   1.94223539e-09,   2.17690089e-09,
         1.94976779e-09,   1.42715084e-09,   8.34765131e-10,
         3.55791540e-10,   7.93139649e-11,   0.00000000e+00,
         5.14227603e-11,   1.49557111e-10,   2.27500038e-10,
         2.52169626e-10,   2.23363144e-10,   1.61686219e-10,
         9.35280617e-11,   3.94228263e-11,   8.69113121e-12,
         0.00000000e+00,   5.51100801e-12,   1.58510205e-11,
         2.38454840e-11,   2.61391794e-11,   2.28973485e-11,
         1.63915941e-11,   9.37701532e-12,   3.90881354e-12,
         8.52212715e-13,   0.00000000e+00,   5.28508233e-13,
         1.50332351e-12,   2.23653587e-12,   2.42457812e-12,
         2.10040929e-12,   1.48701187e-12,   8.41264136e-13,
         3.46806484e-13,   7.47764375e-14,   0.00000000e+00,
         4.53542019e-14,   1.27582976e-13,   1.87711401e-13,
         2.01245172e-13,   1.72412094e-13,   1.20712636e-13,
         6.75375312e-14,   2.75343305e-14,   5.87119613e-15,
         0.00000000e+00,   3.48279858e-15,   9.68898008e-15,
         1.40977723e-14,   1.49471990e-14,   1.26641655e-14,
         8.76871780e-15,   4.85180174e-15,   1.95617134e-15,
         4.12509034e-16,   0.00000000e+00,   2.39322894e-16,
         6.58428250e-16,   9.47448019e-16,   9.93434463e-16,
         8.32396968e-16,   5.69986421e-16,   3.11893244e-16,
         1.24361033e-16,   2.59349490e-17,   0.00000000e+00,
         1.47158445e-17,   4.00390631e-17,   5.69777570e-17,
         5.90831558e-17,   4.89586526e-17,   3.31541565e-17,
         1.79413016e-17,   7.07468006e-18,   1.45909103e-18,
         0.00000000e+00,   8.09713153e-19,   2.17873502e-18,
         3.06619917e-18,   3.14436681e-18,   2.57675711e-18,
         1.72566510e-18,   9.23521444e-19,   3.60142477e-19,
         7.34555200e-20,   0.00000000e+00,   3.98677984e-20,
         1.06088908e-19,   1.47652374e-19,   1.49743432e-19,
         1.21356367e-19,   8.03748367e-20,   4.25387847e-20,
         1.64054047e-20,   3.30911259e-21,   0.00000000e+00,
         1.75654133e-21,   4.62253921e-21,   6.36246730e-21,
         6.38127434e-21,   5.11442373e-21,   3.34987614e-21,
         1.75334844e-21,   6.68720452e-22,   1.33396276e-22,
         0.00000000e+00,   6.92531523e-23,   1.80233819e-22,
         2.45332876e-22,   2.43339218e-22,   1.92874985e-22,
         1.24934520e-22,   6.46690440e-23,   2.43919949e-23,
         4.81194803e-24,   0.00000000e+00,   2.44323803e-24,
         6.28835460e-24,   8.46507858e-24,   8.30351278e-24,
         6.50878852e-24,   4.16947348e-24,   2.13437000e-24,
         7.96150357e-25,   1.55325660e-25,   0.00000000e+00,
         7.71324400e-26,   1.96328261e-25,   2.61367327e-25,
         2.53545943e-25,   1.96548382e-25,   1.24515964e-25,
         6.30359109e-26,   2.32534783e-26,   4.48652966e-27,
         0.00000000e+00,   2.17898087e-27,   5.48496263e-27,
         7.22132108e-27,   6.92781898e-27,   5.31109225e-27,
         3.32746818e-27,   1.66590954e-27,   6.07751183e-28,
         1.15963933e-28,   0.00000000e+00,   5.50826497e-29,
         1.37122772e-28,   1.78536523e-28,   1.69387537e-28,
         1.28423137e-28,   7.95697229e-29,   3.93967009e-29,
         1.42137528e-29,   2.68213349e-30,   0.00000000e+00,
         1.24600931e-30,   3.06754225e-30,   3.94986768e-30,
         3.70605137e-30,   2.77873902e-30,   1.70265570e-30,
         8.33706817e-31,   2.97465608e-31,   5.55114917e-32,
         0.00000000e+00,   2.52216100e-32,   6.14068160e-32,
         7.81957373e-32,   7.25581953e-32,   5.38018616e-32,
         3.26024987e-32,   1.57874471e-32,   5.57070067e-33,
         1.02808841e-33,   0.00000000e+00,   4.56845535e-34,
         1.09998728e-33,   1.38525163e-33,   1.27117858e-33,
         9.32163093e-34,   5.58624519e-34,   2.67519547e-34,
         9.33529274e-35,   1.70381756e-35,   0.00000000e+00,
         7.40476058e-36,   1.76320904e-35,   2.19593417e-35,
         1.99283674e-35,   1.44521201e-35,   8.56513392e-36,
         4.05643191e-36,   1.39988099e-36,   2.52674125e-37,
         0.00000000e+00,   1.07398376e-37,   2.52909419e-37,
         3.11497826e-37,   2.79564441e-37,   2.00500878e-37,
         1.17515020e-37,   5.50399358e-38,   1.87844875e-38,
         3.35307687e-39,   0.00000000e+00,   1.39389309e-39,
         3.24617000e-39,   3.95399197e-39,   3.50943497e-39,
         2.48912125e-39,   1.44277185e-39,   6.68277292e-40,
         2.25555095e-40,   3.98172541e-41,   0.00000000e+00,
         1.61884875e-41,   3.72840065e-41,   4.49119180e-41,
         3.94218975e-41,   2.76516394e-41,   1.58506471e-41,
         7.26073434e-42,   2.42354446e-42,   4.23101107e-43,
         0.00000000e+00,   1.68239566e-43,   3.83194217e-43,
         4.56491274e-43,   3.96262439e-43,   2.74878501e-43,
         1.55826527e-43,   7.05910184e-44,   2.33020643e-44,
         4.02311154e-45,   0.00000000e+00,   1.56457023e-45,
         3.52419861e-45,   4.15191463e-45,   3.56429260e-45,
         2.44515120e-45,   1.37082130e-45,   6.14134373e-46,
         2.00485451e-46,   3.42314301e-47,   0.00000000e+00,
         1.30198819e-47,   2.90032631e-47,   3.37916507e-47,
         2.86885664e-47,   1.94632663e-47,   1.07910910e-47,
         4.78104048e-48,   1.54353465e-48,   2.60635201e-49,
         0.00000000e+00,   9.69536319e-50,   2.13588766e-49,
         2.46102179e-49,   2.06628110e-49,   1.38634329e-49,
         7.60142336e-50,   3.33063080e-50,   1.06339585e-50,
         1.77576771e-51,   0.00000000e+00,   6.46050071e-52,
         1.40752141e-51,   1.60386040e-51,   1.33172642e-51,
         8.83630922e-52,   4.79147853e-52,   2.07623078e-52,
         6.55569285e-53,   1.08264057e-53,   0.00000000e+00,
         3.85223997e-54,   8.29997279e-54,   9.35325406e-54,
         7.68043270e-54,   5.03983226e-54,   2.70264640e-54,
         1.15816334e-54,   3.61649019e-55,   5.90646313e-56,
         0.00000000e+00,   2.05544350e-56,   4.37969014e-56,
         4.88094545e-56,   3.96370584e-56,   2.57220937e-56,
         1.36412437e-56,   5.78108107e-57,   1.78525823e-57,
         2.88347211e-58,   0.00000000e+00,   9.81392677e-59,
         2.06802203e-58,   2.27924093e-58,   1.83046826e-58,
         1.17473960e-58,   6.16117815e-59,   2.58222073e-59,
         7.88605593e-60,   1.25964762e-60,   0.00000000e+00,
         4.19300267e-61,   8.73799904e-61,   9.52404793e-61,
         7.56428784e-61,   4.80089224e-61

};

IntervalTimer timer0;
int dac_lut[LENGTH_OF_DAC]; 
float twopi = 3.14159265359 * 2;

int volatile k; // For testing
int volatile j; 
int volatile n_samp; 
int counter; 
int time;
bool volatile LP_Flag = false;
int LPF_counter;
float correction_factor; 

float bp_filter_coeff[N_FILTER_LENGTH] = {
			 0.000313, 0.000472, 0.000426, -0.000000, -0.000941, 
			-0.002438, -0.004382, -0.006499, -0.008370, -0.009499, 
			-0.009417, -0.007804, -0.004587, 0.000000, 0.005424, 
			0.010927, 0.015665, 0.018868, 0.020000, 0.018868, 
			0.015665, 0.010927, 0.005424, 0.000000, -0.004587, 
			-0.007804, -0.009417, -0.009499, -0.008370, -0.006499, 
			-0.004382, -0.002438, -0.000941, -0.000000, 0.000426, 0.000472, 0.000313};


// Coefficients for FIR low-pass filter
// Order: 31
// Fs = 1000
// Fpass = 5
// Fstop = 30
// Density Factor 20
float lp_filter_coeff[N_FILTER_LENGTH] = {
           0.000326, 0.000692, 0.001207, 0.001891, 0.002756, 
           0.003806, 0.005036, 0.006430, 0.007961, 0.009591, 
           0.011275, 0.012958, 0.014582, 0.016086, 0.017413, 
           0.018507, 0.019325, 0.019829, 0.020000, 0.019829, 
           0.019325, 0.018507, 0.017413, 0.016086, 0.014582, 
           0.012958, 0.011275, 0.009591, 0.007961, 0.006430, 
           0.005036, 0.003806, 0.002756, 0.001891, 0.001207, 0.000692, 0.000326};
           
//----------------------------------------------------------------------

void LUT(){
   for(int i = 0; i < LENGTH_OF_DAC; i++){
     dac_lut[i] = (int) ((cos(twopi*((float) i)/ LENGTH_OF_DAC) + 1)*2050);   
   }
}

//------------------------------------------------------------

void ISR(){
  // Set up the DAC
  if(j >= LENGTH_OF_DAC){
    j = 0;
  }
  analogWrite(A14, dac_lut[j]); 
  
  //***************************************
  // Test with a made up PMT Signal
   if(k >= 1002){
    k = 0; 
   // Serial.print("\n\r We filled up the array");
   // delay(5000);
  }
     in_array[n_samp] = pmt_signal[k];
  //*****************************************
  
  //Fill up input fromm ADC
  //in_array[n_samp] = analogRead(A0);
  
  execute_BPF();
  
  k++;
  j++;
  n_samp++;
  
  // Set up ADC and Filter
  if(n_samp >= LENGTH_OF_SIGNAL){
    n_samp = 0; 
    LP_Flag = true; 
  }
}

//------------------------------------------------------------------------

void execute_BPF() {
  after_BPF[n_samp] = in_array[n_samp] * bp_filter_coeff[0];
  
  
  for(int fir_counter = 1; fir_counter < N_FILTER_LENGTH; fir_counter++){
      int fir_index = n_samp + fir_counter;
    if (fir_index >= N_FILTER_LENGTH) {
      fir_index -= N_FILTER_LENGTH;
    }
    after_BPF[n_samp] += in_array[fir_index] * bp_filter_coeff[fir_counter];
  //Serial.print("\n\r after_BPF: ");
  //Serial.print(after_BPF[n_samp]);
  }  
  //Serial.print("\n\r n_samp: ");
  //Serial.print(n_samp);
  //delay(1000);
  //Serial.print("\n\rafter_BPF: ");
  //Serial.print(after_BPF[n_samp]);
}

//-------------------------------------------------------------

void execute_demod(){
  float x_BPF[N_FILTER_LENGTH];
  int lut_index; 
  // Copy in array from the BPF
  for(int i = 0; i < N_FILTER_LENGTH; i++){
      x_BPF[i] = after_BPF[i]; 
  
  }
  // Do the Demodulation so that there is 0 phase shift
  for(int i = 0; i < N_FILTER_LENGTH; i++){
    lut_index = i%LENGTH_OF_DAC-8;
    if(lut_index < 0){
      lut_index += 10; 
    }
    after_cos_mult[i] = x_BPF[i] * dac_lut[lut_index];
  }
}

//-------------------------------------------------------

float execute_LPF(){
  int lp_fifo_num = 36; 
  
  float y_LPF = after_cos_mult[lp_fifo_num]*lp_filter_coeff[0];
 // Serial.print("\n\r after_cos_mult: ");
//  Serial.print(after_cos_mult[lp_fifo_num]);
  
  for(int fir_counter = 1; fir_counter < N_FILTER_LENGTH; fir_counter++){
        int fir_index = lp_fifo_num + fir_counter;
      if (fir_index >= N_FILTER_LENGTH) {
        fir_index -= N_FILTER_LENGTH;
      }
      y_LPF += after_cos_mult[fir_index] * lp_filter_coeff[fir_counter];
  
    }  
   //Serial.print("\n\r y_LPF: ");
   // Serial.print(y_LPF);
    
    return y_LPF/correction_factor; 
}


//--------------------------------------------------------------
void timer_setup() { //setup interrupts
  timer0.begin(ISR, TIMER_INT_MICROS);  
} //timer_setup() 

//---------------------------------------------------------------------
void setup() {
  analogWriteResolution(12); // Set up DAC resolution
  analogReadResolution(12); 
  k = 0; 
  j = 0; 
  n_samp = 0; 
  counter = 0; 
  LPF_counter = 0; 
  correction_factor = 0; 
  
  for(int i = 0; i < N_FILTER_LENGTH; i++){
    correction_factor += lp_filter_coeff[i]; 
  } 
  
  Serial.begin(BAUD_RATE);
  Serial.flush();
  delay(5000); 
  LUT(); 
  Serial.print("\n\rHello! Right now we are testing the DSP with a fake pmt_signal."); 
  Serial.print("\n\r Correction factor: ");
  Serial.print(correction_factor);
  delay(1000); 
  timer_setup(); 
}//setup

//-----------------------------------------------------------------------

void loop() {

  if(LP_Flag){

    
    execute_demod();
  //Serial.print("\n\r After_cos_mult: ");
  //Serial.print(after_cos_mult[n_samp]);

    after_LPF = (int) 10*execute_LPF();
   // after_LPF = after_LPF*10;
Serial.print("\n\r after_LPF: ");
//Serial.println(after_LPF[LPF_counter], 5);
 //Serial.print("\n\r Average: "); 
   Serial.print(after_LPF);
    
    time = micros();
      
    unsigned char serialBytes[8]; 
    serialBytes[0] = (time >> 24) & 0xff;
    serialBytes[1] = (time >> 16) & 0xff;
    serialBytes[2] = (time >> 8) & 0xff; 
    serialBytes[3] = time & 0xff; 
    serialBytes[4] = (after_LPF >> 24) & 0xff;
    serialBytes[5] = (after_LPF >> 16) & 0xff;
    serialBytes[6] = (after_LPF >> 8) & 0xff; 
    serialBytes[7] = after_LPF & 0xff; 
   // Serial.write(serialBytes,8);
 
  }
  
}
