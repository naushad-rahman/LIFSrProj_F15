

#include "/home/samuelwg/Arduino/libraries/ADC/ADC-master/ADC.h"
//#include "/home/samuelwg/Arduino/libraries/arduino/library/arduino.jar"

#define BAUD_RATE 115200
#define TIMER_INT_MICROS 200
#define LENGTH_OF_DAC 10
#define LENGTH_OF_SIGNAL 37
#define LENGTH_OF_TEST_SIGNAL 1001

#define N_FILTER_LENGTH 37


float bp_filter_coeff[N_FILTER_LENGTH] = {
  0.000313, 0.000472, 0.000426, -0.000000, -0.000941,
  -0.002438, -0.004382, -0.006499, -0.008370, -0.009499,
  -0.009417, -0.007804, -0.004587, 0.000000, 0.005424,
  0.010927, 0.015665, 0.018868, 0.020000, 0.018868,
  0.015665, 0.010927, 0.005424, 0.000000, -0.004587,
  -0.007804, -0.009417, -0.009499, -0.008370, -0.006499,
  -0.004382, -0.002438, -0.000941, -0.000000, 0.000426, 0.000472, 0.000313
};

float test_signal[LENGTH_OF_TEST_SIGNAL] = {
  1.        ,  0.96852063,  0.87606441,  0.72845228,  0.53497771,
  0.30782162,  0.06128546, -0.18910915, -0.42759769, -0.63916522,
  -0.8104917 , -0.93079065, -0.99248818, -0.99169991, -0.92847546,
  -0.80679535, -0.63432043, -0.42190948, -0.18293565,  0.06755558,
  0.3137936 ,  0.54027557,  0.73274247,  0.87907682,  0.97006559,
  0.99998026,  0.96693743,  0.87301743,  0.72413334,  0.52965874,
  0.30183748,  0.05501292, -0.19527519, -0.43326902, -0.64398478,
  -0.81415606, -0.9330691 , -0.99323728, -0.99087249, -0.92612361,
  -0.80306715, -0.62945059, -0.41620462, -0.17675492,  0.07382304,
  0.3197532 ,  0.5455521 ,  0.73700372,  0.88205451,  0.97157226,
  0.99992104,  0.96531605,  0.86993597,  0.71978582,  0.52431885,
  0.29584143,  0.0487382 , -0.20143352, -0.43892324, -0.64877891,
  -0.81778827, -0.93531071, -0.99394716, -0.99000594, -0.9237352 ,
  -0.79930725, -0.62455591, -0.41048332, -0.17056722,  0.08008758,
  0.32570017,  0.55080708,  0.74123588,  0.88499739,  0.97304058,
  0.99982235,  0.96365657,  0.86682018,  0.71540988,  0.51895827,
  0.2898337 ,  0.04246156, -0.2075839 , -0.44456014, -0.65354743,
  -0.8213882 , -0.93751539, -0.9946178 , -0.98910032, -0.92131032,
  -0.79551578, -0.61963657, -0.40474582, -0.16437278,  0.08634896,
  0.33163429,  0.55604033,  0.74543877,  0.88790533,  0.97447048,
  0.99968419,  0.96195904,  0.86367016,  0.71100569,  0.51357719,
  0.28381452,  0.03618325, -0.21372608, -0.45017948, -0.65829015,
  -0.8249557 , -0.93968307, -0.99524918, -0.98815564, -0.91884907,
  -0.79169292, -0.61469277, -0.39899234, -0.15817185,  0.09260693,
  0.33755531,  0.56125162,  0.74961224,  0.89077821,  0.97586191,
  0.99950656,  0.96022354,  0.86048605,  0.70657343,  0.50817585,
  0.27778415,  0.0299035 , -0.21985983, -0.45578106, -0.66300688,
  -0.82849063, -0.94181365, -0.99584126, -0.98717196, -0.91635155,
  -0.7878388 , -0.6097247 , -0.39322311, -0.15196468,  0.09886125,
  0.343463  ,  0.56644076,  0.75375611,  0.89361593,  0.97721481,
  0.99928947,  0.95845013,  0.85726796,  0.70211328,  0.50275444,
  0.2717428 ,  0.02362258, -0.22598489, -0.46136463, -0.66769744,
  -0.83199286, -0.94390704, -0.99639403, -0.9861493 , -0.91381785,
  -0.78395357, -0.60473257, -0.38743836, -0.14575151,  0.10511166,
  0.34935714,  0.57160753,  0.75787023,  0.89641837,  0.97852913,
  0.99903293,  0.95663888,  0.85401604,  0.69762542,  0.49731318,
  0.26569073,  0.01734072, -0.23210103, -0.46693   , -0.67236164,
  -0.83546224, -0.94596318, -0.99690747, -0.98508771, -0.91124807,
  -0.7800374 , -0.59971655, -0.3816383 , -0.13953259,  0.11135793,
  0.35523749,  0.57675174,  0.76195443,  0.89918542,  0.97980483,
  0.99873696,  0.95478986,  0.85073039,  0.69311001,  0.49185229,
  0.25962817,  0.01105818, -0.23820801, -0.47247693, -0.67699929,
  -0.83889863, -0.94798197, -0.99738155, -0.98398724, -0.90864232,
  -0.77609043, -0.59467687, -0.37582319, -0.13330815,  0.11759979,
  0.36110381,  0.58187318,  0.76600854,  0.90191697,  0.98104184,
  0.99840155,  0.95290315,  0.84741117,  0.68856724,  0.48637198,
  0.25355535,  0.0047752 , -0.24430559, -0.47800521, -0.68161022,
  -0.84230191, -0.94996333, -0.99781625, -0.98284791, -0.9060007 ,
  -0.77211283, -0.5896137 , -0.36999323, -0.12707846,  0.12383702,
  0.36695587,  0.58697164,  0.77003242,  0.90461292,  0.98224013,
  0.99802673,  0.95097882,  0.84405848,  0.68399728,  0.48087247,
  0.24747253, -0.00150796, -0.25039352, -0.48351462, -0.68619424,
  -0.84567194, -0.95190719, -0.99821156, -0.98166979, -0.90332331,
  -0.76810474, -0.58452726, -0.36414867, -0.12084375,  0.13006935,
  0.37279345,  0.59204694,  0.77402589,  0.90727315,  0.98339963,
  0.99761251,  0.94901695,  0.84067248,  0.67940032,  0.47535398,
  0.24137994, -0.00779107, -0.25647157, -0.48900494, -0.69075117,
  -0.84900858, -0.95381347, -0.99856747, -0.98045291, -0.90061026,
  -0.76406633, -0.57941774, -0.35828974, -0.11460426,  0.13629655,
  0.37861631,  0.59709886,  0.77798881,  0.90989757,  0.98452032,
  0.9971589 ,  0.94701761,  0.83725329,  0.67477654,  0.46981672,
  0.23527782, -0.01407387, -0.26253949, -0.49447595, -0.69528083,
  -0.8523117 , -0.9556821 , -0.99888395, -0.97919732, -0.89786166,
  -0.75999776, -0.57428535, -0.35241666, -0.10836025,  0.14251837,
  0.38442422,  0.60212721,  0.78192102,  0.91248606,  0.98560213,
  0.99666593,  0.94498089,  0.83380104,  0.67012613,  0.46426091,
  0.22916641, -0.02035611, -0.26859705, -0.49992745, -0.69978304,
  -0.85558118, -0.95751299, -0.999161  , -0.97790308, -0.89507761,
  -0.75589918, -0.56913028, -0.34652966, -0.10211197,  0.14873457,
  0.39021696,  0.60713178,  0.78582235,  0.91503853,  0.98664504,
  0.99613361,  0.94290686,  0.83031588,  0.66544925,  0.45868678,
  0.22304596, -0.02663755, -0.274644  , -0.5053592 , -0.70425763,
  -0.85881687, -0.95930609, -0.9993986 , -0.97657023, -0.89225822,
  -0.75177076, -0.56395275, -0.34062899, -0.09585965,  0.15494489,
  0.39599429,  0.61211239,  0.78969267,  0.91755488,  0.98764899,
  0.99556196,  0.94079561,  0.82679794,  0.66074611,  0.45309453,
  0.2169167 , -0.03291794, -0.28068011, -0.51077101, -0.70870441,
  -0.86201867, -0.96106131, -0.99959675, -0.97519882, -0.88940361,
  -0.74761266, -0.55875295, -0.33471487, -0.08960355,  0.16114909,
  0.40175599,  0.61706884,  0.7935318 ,  0.92003501,  0.98861396,
  0.99495102,  0.93864721,  0.82324735,  0.65601688,  0.4474844 ,
  0.21077887, -0.03919703, -0.28670514, -0.51616265, -0.71312321,
  -0.86518643, -0.9627786 , -0.99975543, -0.97378892, -0.88651388,
  -0.74342505, -0.5535311 , -0.32878753, -0.08334391,  0.16734694,
  0.40750183,  0.62200092,  0.79733961,  0.92247881,  0.98953989,
  0.99430079,  0.93646176,  0.81966427,  0.65126175,  0.44185661,
  0.20463273, -0.04547457, -0.29271885, -0.52153392, -0.71751386,
  -0.86832004, -0.96445787, -0.99987465, -0.97234058, -0.88358916,
  -0.73920808, -0.54828739, -0.32284721, -0.07708098,  0.17353817,
  0.41323158,  0.62690845,  0.80111595,  0.92488619,  0.99042676,
  0.99361131,  0.93423934,  0.81604883,  0.64648091,  0.43621137,
  0.1984785 , -0.05175032, -0.29872101, -0.52688459, -0.72187619,
  -0.87141936, -0.96609907, -0.99995439, -0.97085385, -0.88062956,
  -0.73496194, -0.54302204, -0.31689415, -0.07081501,  0.17972256,
  0.41894502,  0.63179123,  0.80486065,  0.92725706,  0.99127453,
  0.9928826 ,  0.93198003,  0.81240117,  0.64167455,  0.4305489 ,
  0.19231644, -0.05802402, -0.30471137, -0.53221447, -0.72621001,
  -0.87448429, -0.96770213, -0.99999466, -0.96932879, -0.87763519,
  -0.73068678, -0.53773525, -0.31092858, -0.06454624,  0.18589985,
  0.42464192,  0.63664906,  0.80857358,  0.92959133,  0.99208317,
  0.9921147 ,  0.92968394,  0.80872144,  0.63684286,  0.42486945,
  0.18614679, -0.06429544, -0.3106897 , -0.53752333, -0.73051517,
  -0.87751469, -0.96926699, -0.99999545, -0.96776546, -0.87460617,
  -0.72638277, -0.53242723, -0.30495073, -0.05827493,  0.1920698 ,
  0.43032205,  0.64148177,  0.8122546 ,  0.9318889 ,  0.99285264,
  0.99130763,  0.92735114,  0.80500978,  0.63198602,  0.41917321,
  0.17996979, -0.07056431, -0.31665577, -0.54281098, -0.73479149,
  -0.88051045, -0.97079358, -0.99995676, -0.96616393, -0.87154262,
  -0.72205009, -0.52709819, -0.29896085, -0.05200131,  0.19823217,
  0.4359852 ,  0.64628914,  0.81590354,  0.93414967,  0.99358292,
  0.99046143,  0.92498173,  0.80126634,  0.62710424,  0.41346043,
  0.17378568, -0.0768304 , -0.32260933, -0.54807719, -0.7390388 ,
  -0.88347145, -0.97228184, -0.9998786 , -0.96452425, -0.86844467,
  -0.7176889 , -0.52174834, -0.29295916, -0.04572564,  0.20438671,
  0.44163113,  0.65107101,  0.81952027,  0.93637357,  0.99427396,
  0.98957612,  0.9225758 ,  0.79749127,  0.62219769,  0.40773133,
  0.16759471, -0.08309346, -0.32855016, -0.55332177, -0.74325693,
  -0.88639757, -0.97373173, -0.99976096, -0.9628465 , -0.86531243,
  -0.71329938, -0.5163779 , -0.28694591, -0.03944817,  0.21053318,
  0.44725963,  0.65582717,  0.82310465,  0.9385605 ,  0.99492576,
  0.98865174,  0.92013346,  0.79368472,  0.61726659,  0.40198613,
  0.16139713, -0.08935323, -0.33447802, -0.5585445 , -0.74744572,
  -0.88928869, -0.97514317, -0.99960385, -0.96113073, -0.86214603,
  -0.7088817 , -0.51098706, -0.28092133, -0.03316913,  0.21667135,
  0.45287047,  0.66055744,  0.82665654,  0.94071038,  0.99553828,
  0.98768834,  0.91765478,  0.78984683,  0.61231112,  0.39622506,
  0.15519318, -0.09560948, -0.34039268, -0.56374518, -0.751605  ,
  -0.89214471, -0.97651611, -0.99940728, -0.95937703, -0.8589456 ,
  -0.70443603, -0.50557606, -0.27488565, -0.02688879,  0.22280095,
  0.45846343,  0.66526163,  0.83017579,  0.94282312,  0.9961115 ,
  0.98668594,  0.91513988,  0.78597776,  0.60733147,  0.39044835,
  0.14898309, -0.10186195, -0.3462939 , -0.56892361, -0.75573461,
  -0.89496551, -0.9778505 , -0.99917126, -0.95758544, -0.85571125,
  -0.69996256, -0.5001451 , -0.26883913, -0.02060739,  0.22892177,
  0.4640383 ,  0.66993956,  0.83366227,  0.94489864,  0.99664539,
  0.9856446 ,  0.91258885,  0.78207766,  0.60232785,  0.38465623,
  0.14276713, -0.1081104 , -0.35218144, -0.57407958, -0.75983439,
  -0.89775098, -0.97914629, -0.99889579, -0.95575606, -0.85244313,
  -0.69546145, -0.49469439, -0.26278199, -0.01432517,  0.23503354,
  0.46959484,  0.67459104,  0.83711583,  0.94693686,  0.99713994,
  0.98456433,  0.9100018 ,  0.77814669,  0.59730045,  0.37884891,
  0.13654553, -0.11435459, -0.35805508, -0.57921288, -0.76390417,
  -0.900501  , -0.98040343, -0.99858088, -0.95388894, -0.84914135,
  -0.69093288, -0.48922415, -0.25671448, -0.00804239,  0.24113604,
  0.47513285,  0.67921589,  0.84053635,  0.9489377 ,  0.99759512,
  0.9834452 ,  0.90737882,  0.774185  ,  0.59224946,  0.37302665,
  0.13031854, -0.12059426, -0.36391459, -0.58432332, -0.76794379,
  -0.90321548, -0.98162185, -0.99822655, -0.95198416, -0.84580604,
  -0.68637704, -0.4837346 , -0.25063684, -0.00175929,  0.24722902,
  0.48065209,  0.68381392,  0.84392368,  0.95090107,  0.99801092,
  0.98228725,  0.90472001,  0.77019274,  0.5871751 ,  0.36718965,
  0.12408641, -0.12682916, -0.36975973, -0.58941069, -0.77195309,
  -0.90589429, -0.98280153, -0.99783282, -0.9500418 , -0.84243735,
  -0.6817941 , -0.47822595, -0.24454929,  0.00452388,  0.25331223,
  0.48615237,  0.68838496,  0.8472777 ,  0.9528269 ,  0.99838731,
  0.98109052,  0.90202549,  0.76617008,  0.58207756,  0.36133816,
  0.11784937, -0.13305907, -0.37559027, -0.59447479, -0.77593192,
  -0.90853735, -0.98394241, -0.99739969, -0.94806194, -0.8390354 ,
  -0.67718425, -0.47269842, -0.2384521 ,  0.01080687,  0.25938545,
  0.49163345,  0.69292882,  0.85059827,  0.95471511,  0.9987243 ,
  0.97985505,  0.89929536,  0.76211717,  0.57695703,  0.35547241,
  0.11160769, -0.13928371, -0.38140599, -0.59951542, -0.77988011,
  -0.91114453, -0.98504444, -0.99692719, -0.94604465, -0.83560033,
  -0.67254766, -0.46715223, -0.23234549,  0.01708943,  0.26544843,
  0.49709512,  0.69744533,  0.85388526,  0.95656564,  0.99902185,
  0.9785809 ,  0.89652973,  0.75803417,  0.57181373,  0.34959262,
  0.1053616 , -0.14550286, -0.38720665, -0.60453238, -0.78379752,
  -0.91371575, -0.98610759, -0.99641532, -0.94399001, -0.83213226,
  -0.66788452, -0.4615876 , -0.22622971,  0.02337132,  0.27150092,
  0.50253717,  0.7019343 ,  0.85713853,  0.9583784 ,  0.99927997,
  0.97726812,  0.8937287 ,  0.75392125,  0.56664786,  0.34369903,
  0.09911134, -0.15171627, -0.39299202, -0.60952548, -0.78768398,
  -0.9162509 , -0.9871318 , -0.99586413, -0.9418981 , -0.82863135,
  -0.66319501, -0.45600475, -0.220105  ,  0.02965229,  0.2775427 ,
  0.50795937,  0.70639556,  0.86035797,  0.96015333,  0.99949863,
  0.97591676,  0.8908924 ,  0.74977856,  0.56145961,  0.33779187,
  0.09285718, -0.15792369, -0.39876187, -0.61449451, -0.79153935,
  -0.91874987, -0.98811704, -0.99527361, -0.93976901, -0.82509772,
  -0.65847932, -0.45040389, -0.21397159,  0.03593208,  0.28357352,
  0.51336153,  0.71082894,  0.86354345,  0.96189035,  0.99967784,
  0.97452687,  0.88802092,  0.74560628,  0.5562492 ,  0.33187138,
  0.08659935, -0.16412487, -0.40451599, -0.61943929, -0.79536347,
  -0.92121257, -0.98906328, -0.99464381, -0.93760281, -0.82153152,
  -0.65373764, -0.44478525, -0.20782974,  0.04221046,  0.28959315,
  0.51874342,  0.71523425,  0.86669483,  0.9635894 ,  0.99981758,
  0.97309851,  0.88511438,  0.74140456,  0.55101683,  0.32593778,
  0.0803381 , -0.17031957, -0.41025413, -0.62435961, -0.79915619,
  -0.9236389 , -0.98997047, -0.99397474, -0.9353996 , -0.81793289,
  -0.64897014, -0.43914905, -0.20167969,  0.04848717,  0.29560134,
  0.52410482,  0.71961132,  0.869812  ,  0.9652504 ,  0.99991785,
  0.97163173,  0.8821729 ,  0.73717356,  0.54576271,  0.31999132,
  0.07407368, -0.17650755, -0.41597608, -0.62925528, -0.80291736,
  -0.92602877, -0.99083858, -0.99326643, -0.93315947, -0.81430196,
  -0.64417703, -0.43349552, -0.19552168,  0.05476197,  0.30159787,
  0.52944554,  0.72395999,  0.87289483,  0.9668733 ,  0.99997865,
  0.9701266 ,  0.87919659,  0.73291347,  0.54048704,  0.31403223,
  0.06780633, -0.18268856, -0.42168161, -0.63412611, -0.80664683,
  -0.92838209, -0.99166757, -0.9925189 , -0.93088249, -0.81063889,
  -0.63935849, -0.42782487, -0.18935594,  0.0610346 ,  0.30758248,
  0.53476536,  0.72828008,  0.8759432 ,  0.96845803,  0.99999997,
  0.96858316

};
float in_array[LENGTH_OF_SIGNAL];
float volatile after_BPF[LENGTH_OF_SIGNAL];
float zero_array[N_FILTER_LENGTH] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

IntervalTimer timer0;


int volatile k; // For testing
int volatile n_samp;
int time;
int volatile y;




//----------------------------------------------------------
float fir_basic(float input, int ntaps, const float h[], float z[])
{
  int ii;
  float accum;

  /* store input at the beginning of the delay line */
  z[0] = input;

  /* calc FIR */
  accum = 0;
  for (ii = 0; ii < ntaps; ii++) {
    accum += h[ii] * z[ii];
  }

  /* shift delay line */
  for (ii = ntaps - 2; ii >= 0; ii--) {
    z[ii + 1] = z[ii];
  }

  return accum;
}

//-----------------------------------------------------------------
void ISR() {
  //***************************************
  // Test with a a regular cosine
  if (k >= 1002) {
    k = 0;
  }
  in_array[n_samp] = test_signal[k];
  if (n_samp >= LENGTH_OF_SIGNAL) {
    n_samp = 0;
    for (int i = 0; i <= N_FILTER_LENGTH; i++) {
      after_BPF[i] = fir_basic(in_array[i], N_FILTER_LENGTH,  bp_filter_coeff, zero_array);
      // Serial.print("\n\r after_BPF: ");
      Serial.println(after_BPF[i], 5);
    }
  }

  //*****************************************

  //Serial.print("\n\rinput_signal: ");
  // Serial.print(in_array[n_samp]);

  n_samp++;
  k ++;


}

//--------------------------------------------------------------
void timer_setup() { //setup interrupts
  timer0.begin(ISR, TIMER_INT_MICROS);

} //timer_setup()
//-----------------------------------------------------------

void setup() {

  n_samp = 0;
  k = 0;
  Serial.begin(BAUD_RATE);
  Serial.flush();
  delay(5000);
  timer_setup();
  Serial.print("\n\rHello! Right now we are testing the BPF");

}



void loop() {
  time = micros();



}
